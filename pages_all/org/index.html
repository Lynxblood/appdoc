<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Advanced Page Builder</title>
    
</head>
<body>
    <main>
        <section class="panel">
            <h2>Controls</h2>
            <div class="button-group">
                <button data-cmd="bold" title="Bold"><i class="fas fa-bold"></i></button>
                <button data-cmd="italic" title="Italic"><i class="fas fa-italic"></i></button>
                <button data-cmd="underline" title="Underline"><i class="fas fa-underline"></i></button>
                <button data-cmd="strikethrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
            </div>
            
            <div class="button-group">
                <button id="h1Btn" title="Heading 1">H1</button>
                <button id="h2Btn" title="Heading 2">H2</button>
                <button id="pBtn" title="Paragraph">P</button>
            </div>

            <div class="button-group">
                <button data-cmd="subscript" title="Subscript"><i class="fas fa-subscript"></i></button>
                <button data-cmd="superscript" title="Superscript"><i class="fas fa-superscript"></i></button>
                <button data-cmd="removeFormat" title="Clear Formatting"><i class="fas fa-eraser"></i></button>
            </div>

            <h2>Text Formatting</h2>
            <div class="button-group">
                <button data-cmd="justifyLeft" title="Align Left"><i class="fas fa-align-left"></i></button>
                <button data-cmd="justifyCenter" title="Align Center"><i class="fas fa-align-center"></i></button>
                <button data-cmd="justifyRight" title="Align Right"><i class="fas fa-align-right"></i></button>
                <button data-cmd="justifyFull" title="Justify"><i class="fas fa-align-justify"></i></button>
            </div>
            
            <div class="button-group">
                <label for="textColor">Color <input type="color" id="textColor" value="#1a202c" /></label>
                <label for="highlightColor">Highlight <input type="color" id="highlightColor" value="#ffc107" /></label>
            </div>

            <div class="button-group">
                <button data-cmd="indent" title="Indent"><i class="fas fa-indent"></i></button>
                <button data-cmd="outdent" title="Outdent"><i class="fas fa-outdent"></i></button>
                <button data-cmd="insertUnorderedList" title="Bulleted List"><i class="fas fa-list-ul"></i></button>
                <button data-cmd="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
            </div>
            <div class="button-group">
                <select id="fontSelect">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                </select>
                <select id="fontSizeSelect">
                    <option value="1">Small</option>
                    <option value="3" selected>Normal</option>
                    <option value="5">Large</option>
                </select>
            </div>
            <div class="button-group">
                <label for="lineHeightSelect">Line Spacing</label>
                <select id="lineHeightSelect">
                    <option value="1.0">Single</option>
                    <option value="1.5">1.5 Lines</option>
                    <option value="1.6" selected>Normal</option>
                    <option value="2.0">Double</option>
                </select>
            </div>

            <h2>Insert</h2>
            <div class="button-group">
                <button id="insertTableBtn" title="Insert Table"><i class="fas fa-table"></i> Insert Table</button>
            </div>
            <div class="button-group">
                <label for="imgInput">Image</label>
                <input id="imgInput" type="file" accept="image/*" style="flex:1">
            </div>
            <div class="button-group">
                <input id="linkInput" placeholder="https://example.com" class="full-width" />
                <button id="insertLinkBtn"><i class="fas fa-link"></i> Insert Link</button>
                <button id="unlinkBtn"><i class="fas fa-unlink"></i> Remove Link</button>
            </div>

            <h2>Export options</h2>

            <div class="button-group">
                <label for="pageSizeSelect">PDF Size</label>
                <select id="pageSizeSelect">
                    <option value="A4" selected>A4</option>
                    <option value="Letter">Letter</option>
                    <option value="Legal">Legal</option>
                </select>
            </div>

            <div class="button-group">
                <button id="clearBtn"><i class="fas fa-trash"></i> Clear</button>
                <button id="exportPdfBtn"><i class="fas fa-file-pdf"></i> Export PDF</button>
            </div>
        </section>

        <section class="panel preview-wrap">
            <div class="header-with-input">
                <label for="filenameInput" class="panel-label">File Name:</label>
                <input id="filenameInput" value="page-export.pdf" class="filename-input" />
            </div>
            <div id="editor" contenteditable="true">
                <h1>Your page title</h1>
                <p>Start writing your page here. Use the toolbar to format text, add lists, images, and links.</p>
                <p>This is a paragraph with some <b>bold</b>, <i>italic</i>, and <u>underlined</u> text. Try changing the font or color from the control panel.</p>
            </div>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        const editor = document.getElementById('editor');

        // Text formatting
        document.querySelectorAll('[data-cmd]').forEach(btn => {
            btn.addEventListener('click', () => {
                const cmd = btn.getAttribute('data-cmd');
                document.execCommand(cmd, false, null);
                editor.focus();
            });
        });
        document.getElementById('h1Btn').addEventListener('click', () => document.execCommand('formatBlock', false, 'h1'));
        document.getElementById('h2Btn').addEventListener('click', () => document.execCommand('formatBlock', false, 'h2'));
        document.getElementById('pBtn').addEventListener('click', () => document.execCommand('formatBlock', false, 'p'));

        // Color & Highlight
        document.getElementById('textColor').addEventListener('input', (e) => {
            document.execCommand('foreColor', false, e.target.value);
            editor.focus();
        });
        document.getElementById('highlightColor').addEventListener('input', (e) => {
            document.execCommand('backColor', false, e.target.value);
            editor.focus();
        });

        // Font & Size
        document.getElementById('fontSelect').addEventListener('change', (e) => {
            document.execCommand('fontName', false, e.target.value);
            editor.focus();
        });
        document.getElementById('fontSizeSelect').addEventListener('change', (e) => {
            document.execCommand('fontSize', false, e.target.value);
            editor.focus();
        });

        // Get the new select element
        const lineHeightSelect = document.getElementById('lineHeightSelect');

        // *** THIS IS THE CORRECTED FUNCTION ***
        function setLineHeight(value) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                let targetElement = range.commonAncestorContainer;

                if (targetElement.nodeType === Node.TEXT_NODE) {
                    targetElement = targetElement.parentNode;
                }

                while (targetElement && targetElement !== editor && !['P', 'H1', 'H2'].includes(targetElement.tagName)) {
                    targetElement = targetElement.parentElement;
                }

                if (targetElement && ['P', 'H1', 'H2'].includes(targetElement.tagName)) {
                    targetElement.style.lineHeight = value;
                } else {
                    editor.style.lineHeight = value;
                }
            }
        }

        // Add event listener for the new select element
        lineHeightSelect.addEventListener('change', (e) => {
            setLineHeight(e.target.value);
            editor.focus();
        });

        // Insert Image
        document.getElementById('imgInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const img = document.createElement('img');
                img.src = reader.result;
                img.style.maxWidth = '100%';
                img.setAttribute('draggable', 'true');
                editor.appendChild(img);
                editor.focus();
            };
            reader.readAsDataURL(file);
        });

        // Insert Link
        document.getElementById('insertLinkBtn').addEventListener('click', () => {
            const url = document.getElementById('linkInput').value.trim();
            if (!url) return;
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                document.execCommand('createLink', false, url);
            } else {
                const text = prompt('Text for the link', url) || url;
                document.execCommand('insertHTML', false, `<a href="${url}" target="_blank">${text}</a>`);
            }
            editor.focus();
        });
        // Add these to your existing script block

        // Insert Table
        document.getElementById('insertTableBtn').addEventListener('click', () => {
            const tableHtml = `
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ccc; padding: 8px;">Header 1</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Header 2</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">Row 1, Cell 1</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Row 1, Cell 2</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">Row 2, Cell 1</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Row 2, Cell 2</td>
                    </tr>
                </tbody>
            </table>
            `;
            document.execCommand('insertHTML', false, tableHtml);
            editor.focus();
        });

        // Remove Link
        document.getElementById('unlinkBtn').addEventListener('click', () => {
            document.execCommand('unlink', false, null);
            editor.focus();
        });

        // Drag & Drop for images
        let draggedItem = null;
        editor.addEventListener('dragstart', (e) => {
            if (e.target.tagName === 'IMG') {
                draggedItem = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', null);
                e.target.style.opacity = '0.5';
            }
        });
        editor.addEventListener('dragover', (e) => {
            e.preventDefault();
            const target = e.target;
            if (draggedItem && (target.tagName === 'IMG' || target.tagName === 'P')) {
                const rect = target.getBoundingClientRect();
                const isAfter = e.clientY > rect.top + rect.height / 2;
                if (isAfter) {
                    target.parentNode.insertBefore(draggedItem, target.nextSibling);
                } else {
                    target.parentNode.insertBefore(draggedItem, target);
                }
            }
        });
        editor.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedItem) {
                draggedItem.style.opacity = '1';
                draggedItem = null;
            }
        });
        editor.addEventListener('dragend', () => {
            if (draggedItem) {
                draggedItem.style.opacity = '1';
                draggedItem = null;
            }
        });



        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('Clear the editor?')) editor.innerHTML = '<h1>Your page title</h1><p>Start writing your page here.</p>';
        });
    </script>
    <script>
        async function renderHtmlToBlob(html, filename = 'file.jpg') {
            if (!html || !html.trim()) return null;
        
            // create offscreen container
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.minWidth = '595px'; // width you want for header/footer capture
            container.innerHTML = html;
            document.body.appendChild(container);
        
            // give fonts/images time to load (adjust if needed)
            try {
                if (document.fonts && document.fonts.ready) await document.fonts.ready;
            } catch (e) { /* ignore */ }
            await new Promise(r => setTimeout(r, 200));
        
            // Render — use JPEG at quality 0.9 to reduce size (less chance of post limits)
            const canvas = await html2canvas(container, {
                scale: 1,            // reduce scale for smaller size; bump to 2 if you need higher DPI
                useCORS: true,
                backgroundColor: '#ffffff',
            });
        
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
            document.body.removeChild(container);
            return blob; // can be appended to FormData
        }
        
        document.getElementById('exportPdfBtn').addEventListener('click', async () => {
            try {
                const content = document.getElementById('editor').innerHTML;
                const filenameInput = document.getElementById('filenameInput').value || 'page-export.pdf';
                const filename = filenameInput.replace(/\.docx$/i, '.pdf');
                const pageSize = document.getElementById('pageSizeSelect').value || 'A4';
        
        
                const form = new FormData();
                form.append('html_content', content);
                form.append('filename', filename);
                form.append('page_size', pageSize);
        
                // Send as multipart/form-data (no manual content-type header)
                const resp = await fetch('export.php', { method: 'POST', body: form });
        
                if (!resp.ok) throw new Error('Server returned ' + resp.status);
                const blob = await resp.blob();
                saveAs(blob, filename); // FileSaver.js already loaded in your page
            } catch (err) {
                console.error('Export error:', err);
                alert('PDF export failed. See console for details.');
            }
        });
        </script>
</body>
</html>


